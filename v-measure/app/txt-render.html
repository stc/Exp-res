<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>ASCII Hit Event Grid with Non-Overlapping Timestamp Columns</title>
    <script src="https://cdn.jsdelivr.net/npm/p5@1.7.0/lib/p5.min.js"></script>
    <script src="https://unpkg.com/p5.js-svg@1.6.0"></script>
  </head>
 <body style="margin:100px; background-color:black;">
    <script>
      let events;
      let asciiChars = ['_','/', ':', '-', '=', '+', '*', '#', '%', '@'];
      let gridCols = 100;
      let gridRows = 100;
      let cellSize = 14;
      let grid = [];
      let mFont;
      let timestampsByRow = {}; // {row: [timestamps]}

      function preload() {
        events = loadJSON('hit_events.json'); 
        mFont = loadFont("IBMPlexMono-Medium.ttf");
      }

      function setup() {
        createCanvas((gridCols + 200) * cellSize / 1.7, gridRows * cellSize, SVG);
        textFont(mFont, cellSize);
        noLoop();

        // Initialize grid with random ASCII chars
        for (let y = 0; y < gridRows; y++) {
          grid[y] = [];
          for (let x = 0; x < gridCols; x++) {
            grid[y][x] = asciiChars[floor(random([0,0,0,0,0,0,1]))];
          }
        }

        // Insert actor/component names and collect timestamps
        let eventsArray = Object.values(events);
        for (let event of eventsArray) {
          let loc = event.location;
          let gridX = floor(map(loc[0], -100, 100, 0, gridCols - 1));
          let gridY = floor(map(loc[1], -100, 100, 0, gridRows - 1));

          let nameString = `${event.actor}_${event.component}`;
          for (let i = 0; i < nameString.length; i++) {
            let x = gridX + i;
            if (x < gridCols) {
              grid[gridY][x] = nameString[i];
            }
          }

          // Store timestamp for the row
          if (!timestampsByRow[gridY]) timestampsByRow[gridY] = [];
          timestampsByRow[gridY].push(event.timestamp.toFixed(2));
        }
      }

      function draw() {
        background(0);

        // Draw grid
        for (let y = 0; y < gridRows; y++) {
          for (let x = 0; x < gridCols; x++) {
            let char = grid[y][x];
            fill(char === '/' || char === '_' ? 100 : 255);
            noStroke();
            text(char, x * cellSize / 1.7, y * cellSize + cellSize);
          }
        }

        // Draw timestamps in **dedicated columns** to avoid overlaps
        fill(255);
        let baseX = gridCols * cellSize / 1.7 + 5;
        let maxColumnWidth = 150; // maximum width per column before wrapping to next column

        for (let row in timestampsByRow) {
          let tsArray = timestampsByRow[row];
          let colIndex = 0;
          let xOffset = baseX;
          let yPos = row * cellSize + cellSize;

          for (let ts of tsArray) {
            let tsText = `[${ts}]`;
            let tsWidth = textWidth(tsText) + 10;

            // wrap to next column if exceeding max width
            if (xOffset + tsWidth - baseX > maxColumnWidth) {
              colIndex++;
              xOffset = baseX + colIndex * maxColumnWidth;
            }

            text(tsText, xOffset, yPos);
            xOffset += tsWidth;
          }
        }

        //save("hit_events_nonoverlap.svg");
      }
    </script>
  </body>
</html>